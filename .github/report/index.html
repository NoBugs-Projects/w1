<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Web Test Framework - Reports Dashboard</title>
    <link rel="stylesheet" href="report_styles.css">
    <link rel="icon" type="image/png" href="logo_icon.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (styles unchanged ‚Äî shortened for brevity; keep your full CSS here) */
        .dashboard-container{max-width:1200px;margin:0 auto;padding:8px}
        /* ... keep the rest of your CSS exactly as you had it ... */
    </style>
</head>
<body>
<div class="dashboard-container">
    <div class="header">
        <div class="logo-container">
            <div class="logo"><img src="logo_icon.png" alt="NoBugs Logo" /></div>
            <h1>Web Test Framework - Analytics Dashboard</h1>
        </div>
        <p id="run-info">Comprehensive Test Reports Dashboard - Run #$RUN_NUMBER</p>
    </div>

    <div id="alert-banner" class="alert-banner" style="display:none;">
        <div>
            <strong>‚ö†Ô∏è Critical Issues Detected</strong>
            <p id="alert-message" style="margin:5px 0 0 0;font-size:.9rem;"></p>
        </div>
        <button onclick="this.parentElement.style.display='none'" style="background:none;border:none;color:inherit;font-size:1.2rem;cursor:pointer;">√ó</button>
    </div>

    <!-- üìä 1. Test Status Overview -->
    <div class="chart-container">
        <h2 class="chart-title">üìä Test Execution Status</h2>

        <div class="kpi-grid">
            <div class="kpi-card" id="pass-rate-card">
                <div class="kpi-label">Pass Rate</div>
                <div class="kpi-value" id="pass-rate-value">$ALLURE_PASS_RATE%</div>
                <div class="coverage-bar"><div class="coverage-fill" id="pass-rate-fill" style="width:$ALLURE_PASS_RATE%"></div></div>
            </div>

            <div class="kpi-card" id="total-tests-card">
                <div class="kpi-label">Total Tests</div>
                <div class="kpi-value" id="total-tests-value">$ALLURE_TOTAL_TESTS</div>
                <div class="metric-details">
                    <span id="passed-tests">$ALLURE_PASSED_TESTS passed</span>
                    <span id="failed-tests">$ALLURE_FAILED_TESTS failed</span>
                </div>
            </div>

            <div class="kpi-card" id="avg-duration-card">
                <div class="kpi-label">Average Duration</div>
                <div class="kpi-value" id="avg-duration-value">$ALLURE_AVG_DURATION</div>
                <div class="metric-details"><span>Total: <span id="total-duration">$ALLURE_TOTAL_DURATION</span></span></div>
            </div>

            <div class="kpi-card" id="critical-failures-card">
                <div class="kpi-label">Critical Failures</div>
                <div class="kpi-value" id="critical-failures-value">$ALLURE_CRITICAL_FAILURES</div>
                <div class="metric-details"><span id="flaky-tests">$ALLURE_FLAKY_TESTS flaky</span></div>
            </div>

            <div class="kpi-card" id="skipped-tests-card">
                <div class="kpi-label">Skipped Tests</div>
                <div class="kpi-value" id="skipped-tests">$ALLURE_SKIPPED_TESTS</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>Test Status Distribution</h3>
                <canvas id="testStatusChart" width="300" height="320"></canvas>
            </div>
        </div>
    </div>

    <!-- ‚öôÔ∏è 2. API Coverage Analysis -->
    <div class="chart-container">
        <h2 class="chart-title">‚öôÔ∏è API Coverage Analysis</h2>

        <div class="kpi-grid">
            <div class="kpi-card" id="api-coverage-card">
                <div class="kpi-label">API Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="api-coverage-gauge"><div class="gauge-value" id="api-coverage-value">$SWAGGER_API_COVERAGE%</div></div>
                </div>
            </div>

            <div class="kpi-card" id="conditions-coverage-card">
                <div class="kpi-label">Conditions Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="conditions-coverage-gauge"><div class="gauge-value" id="conditions-coverage-value">$SWAGGER_CONDITIONS_COVERAGE%</div></div>
                </div>
            </div>

            <div class="kpi-card" id="full-coverage-card">
                <div class="kpi-label">Full Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="full-coverage-gauge"><div class="gauge-value" id="full-coverage-value">$SWAGGER_FULL_COVERAGE%</div></div>
                </div>
            </div>

            <div class="kpi-card" id="partial-coverage-card">
                <div class="kpi-label">Partial Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="partial-coverage-gauge"><div class="gauge-value" id="partial-coverage-value">$SWAGGER_PARTIAL_COVERAGE%</div></div>
                </div>
            </div>

            <div class="kpi-card" id="empty-coverage-card">
                <div class="kpi-label">Empty Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="empty-coverage-gauge"><div class="gauge-value" id="empty-coverage-value">$SWAGGER_EMPTY_COVERAGE%</div></div>
                </div>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" id="operations-coverage-card">
                <div class="kpi-label">Operations Coverage</div>
                <div class="kpi-value" id="operations-coverage-value">$SWAGGER_OPERATIONS_COVERAGE%</div>
                <div class="coverage-bar"><div class="coverage-fill" id="operations-coverage-fill" style="width:$SWAGGER_OPERATIONS_COVERAGE%"></div></div>
                <div class="metric-details">
                    <span>Covered: <span id="covered-operations">$SWAGGER_COVERED_OPERATIONS</span></span>
                    <span>Total: <span id="total-operations">$SWAGGER_TOTAL_OPERATIONS</span></span>
                </div>
            </div>

            <div class="kpi-card" id="tags-coverage-card">
                <div class="kpi-label">Tags Coverage</div>
                <div class="kpi-value" id="tags-coverage-value">$SWAGGER_TAGS_COVERAGE%</div>
                <div class="coverage-bar"><div class="coverage-fill" id="tags-coverage-fill" style="width:$SWAGGER_TAGS_COVERAGE%"></div></div>
                <div class="metric-details">
                    <span>Covered: <span id="covered-tags">$SWAGGER_COVERED_TAGS</span></span>
                    <span>Total: <span id="total-tags">$SWAGGER_TOTAL_TAGS</span></span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>HTTP Method Coverage</h3>
                <canvas id="methodCoverageChart" width="300" height="360"></canvas>
            </div>
            <div class="chart-container">
                <h3>Status Code Coverage</h3>
                <canvas id="statusCodeChart" width="300" height="360"></canvas>
            </div>
        </div>
    </div>

    <!-- Reports Section -->
    <div class="reports-section">
        <h2>üìã Detailed Reports</h2>
        <div class="reports-grid">
            <div class="report-card">
                <div class="report-icon">üìä</div>
                <h3>Allure Test Report</h3>
                <p>Comprehensive test execution results with detailed analytics, screenshots, and performance metrics.</p>
                <a href="$ALLURE_REPORT_URL" id="allure-link" class="btn" target="_blank">
                    <span class="status-indicator"></span>
                    View Allure Report
                </a>
            </div>

            <div class="report-card">
                <div class="report-icon pink">üîç</div>
                <h3>Swagger Coverage Report</h3>
                <p>API endpoint coverage analysis showing which endpoints have been tested and their current status.</p>
                <a href="$SWAGGER_REPORT_URL" id="swagger-link" class="btn pink" target="_blank">
                    <span class="status-indicator"></span>
                    View Swagger Coverage
                </a>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Built with <strong style="color:#08fc04;">NoBugs</strong> ‚ù§Ô∏è for quality assurance</p>
    </div>
</div>

<script>
    const injectedRunNumber = "$RUN_NUMBER";
    let charts = {};

    function getCoverageColor(p){ if(p<20) return '#dc3545'; if(p<70) return '#ffc107'; return '#28a745'; }
    function updateGauge(id, p){ const g=document.getElementById(id); if(!g) return; const v=g.querySelector('.gauge-value'); const c=getCoverageColor(p); g.style.setProperty('--percentage', p); g.style.setProperty('--gauge-color', c); v.textContent=`${p}%`; v.style.color=c; }
    function updateCoverageBar(id, p){ const f=document.getElementById(id); const c=getCoverageColor(p); f.style.width=`${p}%`; f.className=`coverage-fill ${p<20?'coverage-low':p<70?'coverage-medium':'coverage-high'}`; }

    function createTestStatusChart(d){
      const ctx=document.getElementById('testStatusChart').getContext('2d');
      if(charts.testStatus) charts.testStatus.destroy();
      charts.testStatus=new Chart(ctx,{type:'doughnut',data:{labels:['Passed','Failed','Skipped','Flaky','Critical'],datasets:[{data:[d.passedTests||0,d.failedTests||0,d.skippedTests||0,d.flakyTests||0,d.criticalFailures||0],backgroundColor:['#28a745','#dc3545','#6c757d','#ffc107','#dc3545'],borderWidth:2,borderColor:'#fff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{padding:3,font:{size:8},boxWidth:8,boxHeight:8}}}}});
    }
    function createMethodCoverageChart(d){
      const ctx=document.getElementById('methodCoverageChart').getContext('2d');
      if(charts.methodCoverage) charts.methodCoverage.destroy();
      const m=d.methodCoverage||{}, keys=Object.keys(m), vals=keys.map(k=>m[k].coverage||0);
      charts.methodCoverage=new Chart(ctx,{type:'bar',data:{labels:keys,datasets:[{label:'Coverage %',data:vals,backgroundColor:vals.map(getCoverageColor),borderColor:vals.map(getCoverageColor),borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}});
    }
    function createStatusCodeChart(d){
      const ctx=document.getElementById('statusCodeChart').getContext('2d');
      if(charts.statusCode) charts.statusCode.destroy();
      const s=d.statusCodeCoverage||{}, codes=Object.keys(s), cnt=codes.map(k=>s[k]||0);
      charts.statusCode=new Chart(ctx,{type:'bar',data:{labels:codes,datasets:[{label:'Coverage Count',data:cnt,backgroundColor:'#007bff',borderColor:'#0056b3',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}});
    }

    function updateDashboard(data){
      if(data.allure){ createTestStatusChart(data.allure); updateCoverageBar('pass-rate-fill', data.allure.passRate||0); }
      if(data.swagger){ updateGauge('api-coverage-gauge', data.swagger.apiCoverage||0); updateGauge('conditions-coverage-gauge', data.swagger.conditionsCoverage||0); createMethodCoverageChart(data.swagger); createStatusCodeChart(data.swagger); }
    }

    function loadMetrics(){
      fetch('metrics.json').then(r=>{ if(!r.ok) throw new Error('no metrics'); return r.json(); })
        .then(updateDashboard)
        .catch(()=>{ /* optional: fallback demo data */ });
    }

    document.addEventListener('DOMContentLoaded', function(){
      // Links + run number already injected by template variables
      loadMetrics();
    });
</script>
</body>
</html>
