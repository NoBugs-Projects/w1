<!-- .github/report/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Web Test Framework - Reports Dashboard</title>

    <!-- External styles (cache-busted by run number) -->
    <link rel="stylesheet" href="report_styles.css?v=$RUN_NUMBER">
    <link rel="icon" type="image/png" href="logo_icon.png">

    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Layout basics (keep your full CSS in report_styles.css) */
        .dashboard-container{max-width:1200px;margin:0 auto;padding:8px}
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin-bottom:10px}
        .kpi-card{background:#fff;border-radius:6px;padding:10px;box-shadow:0 1px 3px rgba(0,0,0,.1);border-left:3px solid #007bff}
        .chart-container{background:#fff;border-radius:6px;padding:8px;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:8px}
        .coverage-bar{background:#f0f0f0;border-radius:6px;height:12px;margin:5px 0;overflow:hidden}
        .coverage-fill{height:100%;border-radius:10px}
        .coverage-low{background:#dc3545}.coverage-medium{background:#ffc107}.coverage-high{background:#28a745}
        .gauge-container{text-align:center;padding:8px}
        .gauge{width:90px;height:90px;border-radius:50%;margin:0 auto 8px;position:relative;background:conic-gradient(var(--gauge-color) 0deg,var(--gauge-color) calc(var(--percentage)*3.6deg),#f0f0f0 calc(var(--percentage)*3.6deg),#f0f0f0 360deg)}
        .gauge::before{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:56px;height:56px;background:#fff;border-radius:50%}
        .gauge-value{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:700}
        .reports-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px}
        .report-card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
        .btn{display:inline-block;margin-top:8px;padding:8px 12px;border-radius:6px;background:#0d6efd;color:#fff;text-decoration:none}
        .btn.pink{background:#e91e63}

        /* Ensure donut height is strictly limited to 270px maximum */
        #testStatusChart{width:100% !important;height:270px !important;max-height:270px !important;}
        
        /* Ensure HTTP Method Coverage and Status Code Coverage charts are strictly limited to 270px maximum */
        #methodCoverageChart{width:100% !important;height:270px !important;max-height:270px !important;}
        #statusCodeChart{width:100% !important;height:270px !important;max-height:270px !important;}
        
        /* Test coverage bar styling */
        #test-coverage-fill{transition:width 0.3s ease}
    </style>
</head>
<body>
<div class="dashboard-container">
    <div class="header">
        <div class="logo-container">
            <div class="logo"><img src="logo_icon.png" alt="NoBugs Logo" /></div>
            <h1>Web Test Framework - Analytics Dashboard</h1>
        </div>
        <p id="run-info">Comprehensive Test Reports Dashboard - Run #$RUN_NUMBER</p>
    </div>

    <!-- üìä 1. Test Status Overview -->
    <div class="chart-container">
        <h2 class="chart-title">üìä Test Execution Status</h2>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card" id="pass-rate-card">
                <div class="kpi-label">Pass Rate</div>
                <div class="kpi-value" id="pass-rate-value">$ALLURE_PASS_RATE%</div>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="pass-rate-fill" style="width: $ALLURE_PASS_RATE%"></div>
                </div>
            </div>

            <div class="kpi-card" id="total-tests-card">
                <div class="kpi-label">Total Tests</div>
                <div class="kpi-value" id="total-tests-value">$ALLURE_TOTAL_TESTS</div>
                <div class="metric-details">
                    <span id="passed-tests">$ALLURE_PASSED_TESTS passed</span>
                    <span id="failed-tests">$ALLURE_FAILED_TESTS failed</span>
                </div>
            </div>

            <div class="kpi-card" id="avg-duration-card">
                <div class="kpi-label">Average Duration</div>
                <div class="kpi-value" id="avg-duration-value">$ALLURE_AVG_DURATION</div>
                <div class="metric-details">Total: <span id="total-duration">$ALLURE_TOTAL_DURATION</span></div>
            </div>

            <div class="kpi-card" id="critical-failures-card">
                <div class="kpi-label">Critical Failures</div>
                <div class="kpi-value" id="critical-failures-value">$ALLURE_CRITICAL_FAILURES</div>
                <div class="metric-details"><span id="flaky-tests">$ALLURE_FLAKY_TESTS flaky</span></div>
            </div>

            <div class="kpi-card" id="skipped-tests-card">
                <div class="kpi-label">Skipped Tests</div>
                <div class="kpi-value" id="skipped-tests">$ALLURE_SKIPPED_TESTS</div>
            </div>

            <div class="kpi-card" id="test-coverage-card">
                <div class="kpi-label">Test Coverage</div>
                <div class="kpi-value" id="test-coverage-value">$TEST_COVERAGE_PERCENTAGE%</div>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="test-coverage-fill" style="width: $TEST_COVERAGE_PERCENTAGE%"></div>
                </div>
                <div class="metric-details">
                    <span id="automated-tests">$TEST_COVERAGE_AUTOMATED automated</span>
                    <span id="manual-tests">$TEST_COVERAGE_MANUAL manual</span>
                </div>
            </div>
        </div>

        <!-- Donut (70% height of width) -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>Test Status Distribution</h3>
                <canvas id="testStatusChart"></canvas>
            </div>
        </div>
    </div>

    <!-- ‚öôÔ∏è 2. API Coverage Analysis -->
    <div class="chart-container">
        <h2 class="chart-title">‚öôÔ∏è API Coverage Analysis</h2>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">API Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="api-coverage-gauge">
                        <div class="gauge-value" id="api-coverage-value">$SWAGGER_API_COVERAGE%</div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Conditions Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="conditions-coverage-gauge">
                        <div class="gauge-value" id="conditions-coverage-value">$SWAGGER_CONDITIONS_COVERAGE%</div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Full Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="full-coverage-gauge">
                        <div class="gauge-value" id="full-coverage-value">$SWAGGER_FULL_COVERAGE%</div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Partial Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="partial-coverage-gauge">
                        <div class="gauge-value" id="partial-coverage-value">$SWAGGER_PARTIAL_COVERAGE%</div>
                    </div>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Empty Coverage</div>
                <div class="gauge-container">
                    <div class="gauge" id="empty-coverage-gauge">
                        <div class="gauge-value" id="empty-coverage-value">$SWAGGER_EMPTY_COVERAGE%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Operations Coverage</div>
                <div class="kpi-value" id="operations-coverage-value">$SWAGGER_OPERATIONS_COVERAGE%</div>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="operations-coverage-fill" style="width: $SWAGGER_OPERATIONS_COVERAGE%"></div>
                </div>
                <div class="metric-details">
                    <span>Covered: <span id="covered-operations">$SWAGGER_COVERED_OPERATIONS</span></span>
                    <span>Total: <span id="total-operations">$SWAGGER_TOTAL_OPERATIONS</span></span>
                </div>
            </div>

            <div class="kpi-card">
                <div class="kpi-label">Tags Coverage</div>
                <div class="kpi-value" id="tags-coverage-value">$SWAGGER_TAGS_COVERAGE%</div>
                <div class="coverage-bar">
                    <div class="coverage-fill" id="tags-coverage-fill" style="width: $SWAGGER_TAGS_COVERAGE%"></div>
                </div>
                <div class="metric-details">
                    <span>Covered: <span id="covered-tags">$SWAGGER_COVERED_TAGS</span></span>
                    <span>Total: <span id="total-tags">$SWAGGER_TOTAL_TAGS</span></span>
                </div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>HTTP Method Coverage</h3>
                <canvas id="methodCoverageChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Status Code Coverage</h3>
                <canvas id="statusCodeChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Reports links -->
    <div class="reports-section">
        <h2>üìã Detailed Reports</h2>
        <div class="reports-grid">
            <div class="report-card">
                <div class="report-icon">üìä</div>
                <h3>Allure Test Report</h3>
                <p>Comprehensive test execution results with detailed analytics.</p>
                <a href="$ALLURE_REPORT_URL" id="allure-link" class="btn" target="_blank">View Allure Report</a>
            </div>

            <div class="report-card">
                <div class="report-icon pink">üîç</div>
                <h3>Swagger Coverage Report</h3>
                <p>API endpoint coverage analysis and testing status.</p>
                <a href="$SWAGGER_REPORT_URL" id="swagger-link" class="btn pink" target="_blank">View Swagger Coverage</a>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Built with <strong style="color:#08fc04;">NoBugs</strong> ‚ù§Ô∏è for quality assurance</p>
    </div>
</div>

<script>
    let charts = {};

    function getCoverageColor(p){ if(p<20) return '#dc3545'; if(p<70) return '#ffc107'; return '#28a745'; }
    function setGauge(id, p){
      var g=document.getElementById(id); if(!g) return;
      var v=g.querySelector('.gauge-value'); var c=getCoverageColor(p);
      g.style.setProperty('--percentage', p); g.style.setProperty('--gauge-color', c);
      v.textContent = p + '%'; v.style.color=c;
    }
    function setBarWidth(id, p){
      var f=document.getElementById(id); if(!f) return;
      var c=getCoverageColor(p); f.style.width = p + '%';
      f.className = 'coverage-fill ' + (p<20?'coverage-low':(p<70?'coverage-medium':'coverage-high'));
    }

    function createTestStatusChart(data){
      var ctx=document.getElementById('testStatusChart').getContext('2d');
      if(charts.testStatus) charts.testStatus.destroy();
      charts.testStatus=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Passed','Failed','Skipped','Flaky','Critical'],
          datasets:[{
            data:[
              data.passedTests||0,
              data.failedTests||0,
              data.skippedTests||0,
              data.flakyTests||0,
              data.criticalFailures||0
            ],
            backgroundColor:['#28a745','#dc3545','#6c757d','#ffc107','#dc3545'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          layout:{ padding:{ top:3, bottom:3, left:3, right:3 } },
          plugins:{ legend:{ position:'bottom', labels:{ padding:3, font:{ size:10 }, boxWidth:10, boxHeight:10 } } }
        }
      });
    }

    function createMethodCoverageChart(d){
      var ctx=document.getElementById('methodCoverageChart').getContext('2d');
      if(charts.methodCoverage) charts.methodCoverage.destroy();
      var m=d.methodCoverage||{}, keys=Object.keys(m), vals=keys.map(function(k){ return m[k].coverage||0; });
      charts.methodCoverage=new Chart(ctx,{
        type:'bar',
        data:{ labels:keys, datasets:[{ label:'Coverage %', data:vals, backgroundColor:vals.map(getCoverageColor), borderColor:vals.map(getCoverageColor), borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true, max:100 } } }
      });
    }

    function createStatusCodeChart(d){
      var ctx=document.getElementById('statusCodeChart').getContext('2d');
      if(charts.statusCode) charts.statusCode.destroy();
      var s=d.statusCodeCoverage||{}, codes=Object.keys(s), cnt=codes.map(function(k){ return s[k]||0; });
      charts.statusCode=new Chart(ctx,{
        type:'bar',
        data:{ labels:codes, datasets:[{ label:'Coverage Count', data:cnt, backgroundColor:'#007bff', borderColor:'#0056b3', borderWidth:1 }] },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function applyMetrics(data){
      if(data.allure){
        document.getElementById('pass-rate-value').textContent = (data.allure.passRate||0) + '%';
        setBarWidth('pass-rate-fill', Number(data.allure.passRate||0));
        document.getElementById('total-tests-value').textContent = data.allure.totalTests||0;
        document.getElementById('passed-tests').textContent = (data.allure.passedTests||0) + ' passed';
        document.getElementById('failed-tests').textContent = (data.allure.failedTests||0) + ' failed';
        createTestStatusChart(data.allure);
      }
      if(data.swagger){
        setGauge('api-coverage-gauge', Number(data.swagger.apiCoverage||0));
        setGauge('conditions-coverage-gauge', Number(data.swagger.conditionsCoverage||0));
        document.getElementById('operations-coverage-value').textContent = (data.swagger.apiCoverage||0) + '%';
        setBarWidth('operations-coverage-fill', Number(data.swagger.apiCoverage||0));
        createMethodCoverageChart(data.swagger);
        createStatusCodeChart(data.swagger);
      }
      if(data.testCoverage){
        document.getElementById('test-coverage-value').textContent = (data.testCoverage.coveragePercentage||0) + '%';
        setBarWidth('test-coverage-fill', Number(data.testCoverage.coveragePercentage||0));
        document.getElementById('automated-tests').textContent = (data.testCoverage.automatedTests||0) + ' automated';
        document.getElementById('manual-tests').textContent = (data.testCoverage.manualTests||0) + ' manual';
      }
    }

    function loadMetrics(){
      fetch('metrics.json')
        .then(function(r){ if(!r.ok) throw new Error('no metrics'); return r.json(); })
        .then(applyMetrics)
        .catch(function(){ /* keep placeholders if metrics missing */ });
    }

    document.addEventListener('DOMContentLoaded', loadMetrics);
</script>
</body>
</html>
