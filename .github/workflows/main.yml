name: TeamCity deployment

on: [ push, workflow_dispatch ]

jobs:
  # –°–æ–±–∏—Ä–∞–µ—Ç—Å—è –±—ç–∫–µ–Ω–¥ –∏ –¥–µ–ø–ª–æ–∏—Ç—Å—è –Ω–∞ —Å—Ç–µ–π–¥–∂
  backend:
    uses: ./.github/workflows/backend-stage.yml

  # –°–æ–±–∏—Ä–∞–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –¥–µ–ø–ª–æ–∏—Ç—Å—è –Ω–∞ —Å—Ç–µ–π–¥–∂
  frontend:
    uses: ./.github/workflows/frontend-stage.yml

  # –ü—Ä–æ–≥–æ–Ω—è—é—Ç—Å—è API –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã
  automation-api:
    needs: [ backend, frontend ]
    uses: ./.github/workflows/automation.yml
    with:
      package: api

  # –ü—Ä–æ–≥–æ–Ω—è—é—Ç—Å—è UI –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã
  automation-ui:
    needs: [ backend, frontend ]
    uses: ./.github/workflows/automation.yml
    with:
      package: ui

  automation-ui-firefox:
    needs: [ backend, frontend ]
    uses: ./.github/workflows/automation.yml
    with:
      package: ui
      browser: firefox

  # Build and push Docker image only if all tests pass
  docker-push:
    needs: [ automation-api, automation-ui, automation-ui-firefox ]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Debug secrets
        run: |
          echo "üîç Debug Docker secrets:"
          echo "   - DOCKER_USERNAME: ${DOCKER_USERNAME:+SET}"
          echo "   - DOCKER_PASSWORD: ${DOCKER_PASSWORD:+SET}"
          echo "   - Username length: ${#DOCKER_USERNAME}"
          echo "   - Password length: ${#DOCKER_PASSWORD}"
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Docker image
        run: docker build -t nobugsme/wtf-tests:${{ github.sha }} .

      - name: Push Docker image
        run: docker push nobugsme/wtf-tests:${{ github.sha }}

  report:
    needs: [ automation-api, automation-ui, automation-ui-firefox, docker-push ]
    if: always()
    uses: ./.github/workflows/report.yml
    with:
      parent_run_number: ${{ github.run_number }}
      docker_pushed: ${{ needs.docker-push.result == 'success' }}

  # –ù–µ–æ–±—Ö–æ–¥–∏–º –º–∞–Ω—É–∞–ª—å–Ω—ã–π –∞–ø—Ä—É–≤, —á—Ç–æ–±—ã –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å –±—ç–∫–µ–Ω–¥ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–∞ –ø—Ä–æ–¥
  # –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å prod environment. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment#creating-an-environment
  # –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏, –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —à–∞–≥, —á—Ç–æ–±—ã –¥–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥ –Ω–∞—á–∏–Ω–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã
  # –û–¥–Ω–∞–∫–æ, –º–∞–Ω—É–∞–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –∑–¥–µ—Å—å –ø–æ–º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–µ–≤—å—é, –∞ —Ç–∞–∫–∂–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫–∏–µ-—Ç–æ –º–∞–Ω—É–∞–ª—å–Ω—ã–µ –∏–ª–∏ –ø–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å —Ç–µ—Å—Ç—ã,
  # —Ç–∞–∫ –∫–∞–∫ –¥–µ–ø–ª–æ–π –Ω–∞ –ø—Ä–æ–¥ - —ç—Ç–æ –æ—á–µ–Ω—å —Å–µ—Ä—å–µ–∑–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
  manual-prod-approval:
    needs: report
    if: success()
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Approve backend and frontend to production
        run: echo Approved to production

  # –î–µ–ø–ª–æ–π –±—ç–∫–µ–Ω–¥–∞ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ –ø—Ä–æ–¥
  deploy-prod:
    needs: manual-prod-approval
    uses: ./.github/workflows/deploy-prod.yml
